<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="img/quote.jpeg" />
  <link rel="apple-touch-startup-image" href="img/quote.jpeg" />
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="touch-icon" href="img/quote.jpeg" />
  <link rel="touch-startup-image" href="img/quote.jpeg" />

  <!-- Bootstrap -->
  <link href="bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <!--
  <link href="bower_components/jquery-mobile/css/themes/default/jquery.mobile.css" rel="stylesheet">
-->
<link rel="stylesheet" type="text/css" href="css/main.css" media="screen" />

<title>guyirvine.com</title>

<style>
header {
  background-color: rgb(58,87,149);
  padding: 0.7em;
}
header input {
  padding: 0.3em;
  padding-bottom: 0.1em;
  width: 85%;
  border: 1px solid black;
  background-color: rgb(120, 141, 185);
  color: white;
}
header form a {
  padding-left: 1em;
  color: white;
}
header form a:hover {
  color: white;
  text-decoration: underline;
}

footer {
  background-color: rgb(58,87,149);
  padding: 0.5em;
  position: fixed;
  bottom: 0px;
  width: 100%;
}
footer a {
  color: white;
}

body {
  margin-left: 0em;
  margin-right: 0em;
}

div.screen {
  margin-left: 0em;
  margin-right: 0em;
  margin-top: 1em;
}

div.screen h1 {
  margin-left: 1em;
  margin-right: 1em;
}

div.screen div.table {
  border-top: 1px solid #ccc;
  border-bottom: 1px solid #ccc;
  padding-left: 1em;
  padding-right: 1em;
  background-color: #f8f8f8;
}

table {
  background-color: #f8f8f8;
  border: none;
  width: 100%;
  margin-bottom: 0em;
}

h1 {
  font-weight: normal;
  font-size: 1.7em;
  margin-bottom: 0;
  color: #999;
}

body.show footer .add-new-word {
  display: block
}

.hide2 {
  display: none;
}

section.menu {
}

section.menu table {
  width: 100%;
}

section.menu td {
  padding: 6px 3px;
  border: 1px solid #ccc;
  border-top: none;
  width: 25%;
  text-align: center;
}

</style>
</head>
<body>

  <header>
    <form onsubmit='viewModel.search();return false;'>
      <input placeholder='Search' type='search' class='criteria' id='criteria' onkeyup="viewModel.search()" />
      <a class="extra" id="buttoncancel" href="" onclick="viewModel.displayTagged();return false;">cancel</a>
    </form>
  </header>

  <section class='menu'>
    <table>
      <thead>
      </thead>
      <tbody>
        <tr>
          <td>
            <a class="" id="buttontagged" href="" onclick="viewModel.displayTagged();return false;">home</a>
          </td>
          <td>
            <a class="" id="buttonnewword" href="" onclick="viewModel.displayAdd();return false;">new word</a>
          </td>
          <td>
            <a class="extra" id="buttontag" href="" onclick="viewModel.tagCurrent();return false;">tag</a>
            <a class="extra" id="buttonuntag" href="" onclick="viewModel.unTagCurrent();return false;">untag</a>
          </td>
          <td>
            <a class="extra hide" id="buttondelete" href="" onclick="viewModel.delete();return false;">delete</a>
          </td>
        </tr>
      </tbody>
      <tfoot>
      </tfoot>
    </table>
  </section>

  <div class="screen" id="tagged">
    <div class="table">
    <table>
      <thead>
      </thead>
      <tbody>
      </tbody>
      <tfoot>
      </tfoot>
    </table>
    </div>
  </div>

  <div class="screen hide" id="result">
    <div class="table">
    <table>
      <thead>
      </thead>
      <tbody>
      </tbody>
      <tfoot>
      </tfoot>
    </table>
    </div>
  </div>

  <div class="screen hide" id="show">
    <h1></h1>
    <div class="table">
      <table>
        <thead>
        </thead>
        <tbody>
        </tbody>
        <tfoot>
        </tfoot>
      </table>
    </div>
  </div>

  <div class="screen hide" id="add">
    <h1>Add a new Word</h1>
    <form onsubmit="viewModel.newWord();return false">
      <input type='text' class='add word' id="wordnew" />
      <input type='submit' class='new' />
    </form>
  </div>


  <footer>
    <div class="extra hide" id="addnewword">
      <form onsubmit="viewModel.addWord();return false">
        <input type='text' class='add word' id="wordadd" />
        <input type='submit' class='new' />
      </form>
    </div>
    <div>
    <a href="http://twitter.com/#!/guyirvine" class="handle" title="www">@guyirvine</a>
  </div>
  </footer>


  <script src="bower_components/jquery/jquery.min.js"></script>
  <script src="bower_components/knockout/dist/knockout.js"></script>

  <script src="bower_components/underscore/underscore-min.js"></script>



  <script>
  window.onpopstate = function(event) {
    viewModel.popstate( event.state );
  };

  function MainViewModel() {
    var self = this;

    self.taggedViewModel = new TaggedViewModel();
    self.searchBox = new SearchBoxViewModel();
    self.shvm = new ShowViewModel();
    self.sevm = new ResultViewModel();
    self.addvm = new AddViewModel();
    history.pushState( {"view": "tagged"}, "", "#tagged" );

    self.search = function() {
      self.searchBox.run();
    };

    self.newWord = function() {
      self.addvm.newWord();
    };
    self.addWord = function() {
      self.addvm.addWord();
    };

    self.getShowId = function() {
      return self.shvm.id;
    };
    self.refreshShow = function() {
      self.shvm.run( self.getShowId() );
    };
    self.tagCurrent = function() {
      $.post( "/tag/" + self.getShowId(), "", function(id) {
          $( "#buttontag" ).addClass( "hide" );
          $( "#buttonuntag" ).removeClass( "hide" );
        });
    };
    self.unTagCurrent = function() {
      $.post( "/untag/" + self.getShowId(), "", function(id) {
          $( "#buttonuntag" ).addClass( "hide" );
          $( "#buttontag" ).removeClass( "hide" );
        });
    };
    self.delete = function() {
      $.post( "/delete/" + self.getShowId(), "", function(id) {
        window.history.back();
      });
    };

    self.popstate = function( state ) {
      $( ".screen" ).addClass( "hide" );
      $( ".extra" ).addClass( "hide" );

      if ( state === null || state.view === null ) {
        self.taggedViewModel.run();
        $( "#tagged" ).removeClass( "hide" );
        return;
      }

      switch ( state.view ) {
        case "result":
        $( "#result" ).removeClass( "hide" );
        break;
        case "tagged":
        self.taggedViewModel.run();
        $( "#tagged" ).removeClass( "hide" );
        break;
        case "show":
        self.shvm.run( state.id );
        $( "#show" ).removeClass( "hide" );
        $( "#addnewword" ).removeClass( "hide" );
        break;
        case "add":
        self.addvm.word( "" );
        $( "#add" ).removeClass( "hide" );
        break;
        default:
        $( "#result" ).removeClass( "hide" );
      }
    };

    self.displayTagged = function() {
      $( ".screen" ).addClass( "hide" );
      $( ".extra" ).addClass( "hide" );
      self.taggedViewModel.run();
      history.pushState( { "view": "tagged" }, 'Tagged', "#tagged" );
      $( "#tagged" ).removeClass( "hide" );
    };

    self.displayShow = function( id ) {
      $( ".screen" ).addClass( "hide" );
      $( ".extra" ).addClass( "hide" );
      self.shvm.run( id );
      history.pushState( { "id": id, "view": "show" }, 'Show', "#show" );
      $( "#show" ).removeClass( "hide" );
      $( "#addnewword" ).removeClass( "hide" );
      $( "#buttondelete" ).removeClass( "hide" );
    };

    self.displayResult = function() {
      $( ".screen" ).addClass( "hide" );
      $( ".extra" ).addClass( "hide" );
      history.pushState( {"view": "result"}, "", "#result" );
      $( "#result" ).removeClass( "hide" );
      $( "#buttoncancel" ).removeClass( "hide" );
    };

    self.displayAdd = function(_id) {
      $( ".screen" ).addClass( "hide" );
      $( ".extra" ).addClass( "hide" );
      history.pushState( {"view": "add"}, "", "#add" );
      $( "#add" ).removeClass( "hide" );
    };


    self.displayTagged();

  }

  function TaggedViewModel() {
    var self = this;

    self.run = function(id) {
      self.id = id;

      $.getJSON( "/tagged", function( _l ) {

        var content = "";
        if ( _l.length === 0 ) {
          content = "<tr><td>No related words found</td></tr>";
        } else {
          _.each( _l, function( el ) {
            content = content + "<tr>" +
            "<td>" +
              "<a onclick='viewModel.displayShow( " + el.id + " );return false;' class='word-" + el.id + "' href=''>" + el.name + "</a>" +
              "</td>" +
              "</tr>";
            });
          }

        $( "#tagged table tbody" ).html( content );

      });
    };

  }


  //*******************************************************
  function SearchBoxViewModel() {
    var self = this;

    self.criteria = document.getElementById( "criteria" );

    self.running = false;

    self.run = function() {
      if ( self.running === true ) { return; }
      self.running = true;
      if ( $( "#result").hasClass( "hide" ) === true ) {
        viewModel.displayResult();
      }
      self._run();
      self.running = false;
    };

    self._run = function() {
      if ( self.criteria.value === "" ) { $( "#result table tbody" ).html( "" ); return; }

      var criteria = self.criteria.value;
      $.getJSON( "/search/" + criteria, function( _l ) {
        if ( criteria !== self.criteria.value ) {
          self._run();
        } else {
          var content = "";

          if ( _l.length === 0 ) {
            content = "<tr><td>Search returned no results</td></tr>";
          } else {
            _.each( _l, function( el ) {
              content = content + "<tr>" +
              "<td>" +
                "<a onclick='viewModel.displayShow( " + el.id + " );return false;' href=''>" + el.name + "</a>" +
                "</td>" +
                "</tr>";
              });
            }

          $( "#result table tbody" ).html( content );
        }

      });

    };

  }


  function ShowViewModel() {
    var self = this;

    self.id = null;

    self.run = function(id) {
      self.id = id;

      $.getJSON( "/word/" + id, function( el ) {
        $( "#show h1" ).html( el.name );
        if ( el.tagged == 't' ) {
          $( "#buttontag" ).addClass( "hide" );
          $( "#buttonuntag" ).removeClass( "hide" );
        } else {
          $( "#buttonuntag" ).addClass( "hide" );
          $( "#buttontag" ).removeClass( "hide" );
        }
      });

      $.getJSON( "/children/" + id, function( _l ) {

        var content = "";
        if ( _l.length === 0 ) {
          content = "<tr><td>No related words found</td></tr>";
        } else {
          _.each( _l, function( el ) {
            content = content + "<tr>" +
            "<td>" +
              "<a onclick='viewModel.displayShow( " + el.id + " );return false;' class='word-" + el.id + "' href=''>" + el.name + "</a>" +
              "</td>" +
              "</tr>";
            });
          }

        $( "#show table tbody" ).html( content );

      });
    };

  }

  function ResultViewModel() {
    var self = this;
  }

  function AddViewModel() {
    var self = this;

    self.newWord = function() {
      var newword = document.getElementById( "wordnew" );
      var word = newword.value.trim();
      if ( word === "" ) {
        return false;
      }

      $.post( "/word", word, function(id) {
          viewModel.displayShow( id );
      });
    };

    self.addWord = function() {
      var addword = document.getElementById( "wordadd" );
      var word = addword.value.trim();
      if ( word === "" ) {
        return false;
      }

      $.post( "/word", word, function(id) {
        $.post( "/link", JSON.stringify({ word_1: id, word_2: viewModel.getShowId() }), function() {
          viewModel.refreshShow();
          addword.value = "";
        });
      });
    };

  }

  window.onerror = function( msg, url, line, col, error ) {
    alert( msg + "\nline: " + line );
  };

  var viewModel = new MainViewModel();
  //        document.getElementById( "criteria" ).value = 'an';
  </script>

</body>
</html>
