<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="img/quote.jpeg" />
  <link rel="apple-touch-startup-image" href="img/quote.jpeg" />
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="touch-icon" href="img/quote.jpeg" />
  <link rel="touch-startup-image" href="img/quote.jpeg" />

  <!-- Bootstrap -->
  <link href="bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
  <!--
  <link href="bower_components/jquery-mobile/css/themes/default/jquery.mobile.css" rel="stylesheet">
-->
<link rel="stylesheet" type="text/css" href="css/main.css" media="screen" />

<title>guyirvine.com</title>

<style>
header {
  background-color: rgb(58,87,149);
  padding: 0.7em;
}
header input {
  padding: 0.3em;
  padding-bottom: 0.1em;
  width: 85%;
  border: 1px solid black;
  background-color: rgb(120, 141, 185);
  color: white;
}
header form a {
  padding-left: 1em;
  color: white;
}
header form a:hover {
  color: white;
  text-decoration: underline;
}

footer {
  background-color: rgb(58,87,149);
  padding: 0.5em;
  position: fixed;
  bottom: 0px;
  width: 100%;
}
footer a {
  color: white;
}
footer a:hover {
  color: white;
  text-decoration: underline;
}

body {
  margin-left: 0em;
  margin-right: 0em;
}

div.screen {
  margin-left: 0em;
  margin-right: 0em;
  margin-top: 1em;
}

div.screen h1 {
  margin-left: 1em;
  margin-right: 1em;
}

div.screen div.table {
  border-top: 1px solid #ccc;
  border-bottom: 1px solid #ccc;
  padding-left: 1em;
  padding-right: 1em;
  background-color: #f8f8f8;
}

section.menu table {
  background-color: #f8f8f8;
  border: none;
  width: 100%;
  margin-bottom: 0em;
}

h1 {
  font-weight: normal;
  font-size: 1.7em;
  margin-bottom: 0;
  color: #999;
}

body.show footer .add-new-word {
  display: block
}

.hide2 {
  display: none;
}

section.menu {
}

section.menu table {
  width: 100%;
}

section.menu td {
  padding: 6px 3px;
  border: 1px solid #ccc;
  border-top: none;
  width: 25%;
  text-align: center;
}

footer table {
  width: 100%;
}

footer td {
  padding: 6px 3px;
  border: none;
  border-left: 1px solid #ccc;
  width: 33%;
  text-align: center;
}

#popupmenu {
  background-color: white;
  border: 1px solid #ccc;
  position: fixed;
  width: 40%;
  right: 0;
  bottom: 3em;
  padding: 1em;
  color: #333;
}

#popupmenu ul {
  padding-left: 1em;
}

#popupmenu li {
  list-style-type: none;
  padding: 12px 9px;
  border-bottom: 1px solid #ccc;
}

#popupmenu ul a {
  color: #333;
  font-weight: bold;
}
#popupmenu ul a:hover {
  color: #333;
  text-decoration: underline;
}


#popdownmenu {
  background-color: rgb(58,87,149);
  border: 1px solid white;
  position: fixed;
  width: 40%;
  right: 0;
  top: 5em;
  padding: 1em;
  color: white;
}

#popdownmenu ul {
  padding-left: 1em;
}

#popdownmenu li {
  list-style-type: none;
}

li.tick:before
 {
    content: 'âœ”';
    margin-left: -1.5em; margin-right: .500em;
 }

</style>
</head>
<body>

  <header>
    <form onsubmit='viewModel.search();return false;'>
      <input placeholder='Search' type='search' class='criteria' id='criteria' onkeyup="viewModel.search()" />
      <a class="extra" id="buttoncancel" href="" onclick="viewModel.displayTagged();return false;">cancel</a>
    </form>
  </header>

  <section class='menu'>
    <table>
      <thead>
      </thead>
      <tbody>
        <tr>
          <td>
            <a class="" id="buttontagged" href="" onclick="viewModel.displayTagged();return false;">home</a>
          </td>
          <td>
            <a class="" id="buttonnewword" href="" onclick="viewModel.displayAdd();return false;">new word</a>
          </td>
          <td>
            <a href="" onclick="popdownmenu();return false;" class='extra' id='displayheadermenu'>...</a>
          </td>
        </tr>
      </tbody>
      <tfoot>
      </tfoot>
    </table>

    <div id="popdownmenu" class="hide" onblur="$( '#popdownmenu' ).addClass( 'hide' );">
      <ul>
        <li>
        </li>
        <li>
          <a class="extra" id="buttondelete" href="" onclick="viewModel.delete();return false;">delete</a>
        </li>
      </ul>
    </div>

  </section>

  <div class="screen" id="tagged">
    <div class="table">
      <table>
        <thead>
        </thead>
        <tbody>
        </tbody>
        <tfoot>
        </tfoot>
      </table>
    </div>
  </div>

  <div class="screen hide" id="result">
    <div class="table">
      <table>
        <thead>
        </thead>
        <tbody>
        </tbody>
        <tfoot>
        </tfoot>
      </table>
    </div>
  </div>

  <div class="screen hide" id="show">
    <h1><a id="showwordname" href="" onblur="viewModel.changeWord();return false" contenteditable="true"></a></h1>
    <div class="table">
      <form id='formsearchadd' class='extra formsearchadd' onsubmit='viewModel.addWord();return false;'>
        <input placeholder='Search' type='search' class='textsearchadd' id='textsearchadd' onkeyup="viewModel.searchadd()" />
        <input type='submit' class='new' />
        <a class="" id="buttonsearchaddcancel" href="" onclick="viewModel.showSearchAdd();return false;">cancel</a>
      </form>
      <table>
        <thead>
        </thead>
        <tbody>
        </tbody>
        <tfoot>
        </tfoot>
      </table>
    </div>
  </div>

  <div class="screen hide" id="add">
    <h1>Add a new Word</h1>
    <form onsubmit="viewModel.newWord();return false">
      <input type='text' class='add word' id="wordnew" />
      <input type='submit' class='new' />
    </form>
  </div>


  <footer>
    <div class="extra hide" id="formseturl">
      <form onsubmit="viewModel.setUrl();return false">
        <input type='text' class='' id="textseturl" />
        <input type='submit' class='new' />
        <a href="" onclick="viewModel.hideSetUrl();return false;">cancel</a>
      </form>
    </div>
    <div class="extra hide" id="formaddword">
      <a href="" onclick="viewModel.displayLoadWords();return false;" class="handle">load words</a>
      <form onsubmit="viewModel.addWord();return false">
        <input type='text' class='add word' id="wordadd" />
        <input type='submit' class='new' />
      </form>
    </div>
    <div class="extra hide" id="formloadwords">
      <a href="" onclick="viewModel.displayAddWord();return false;" class="handle">add word</a>
      <form onsubmit="viewModel.loadWords();return false">
        <textarea class='add word' id="textarealoadwords"></textarea>
        <input type='submit' class='new' />
      </form>
    </div>


    <div id="popupmenu" class="extra hide" onblur="$( '#popupmenu' ).addClass( 'hide' );">
      <ul>
        <li>
          <a class="" id="buttonseturl" href="" onclick="viewModel.displaySetUrl();return false;">Set Url</a>
        </li>
        <li class="treeview">
          <a href="" onclick="viewModel.singleLevelCurrent();return false;" class="handle extra" id="buttonsinglelevel">Tree View</a>
          <a href="" onclick="viewModel.multiLevelCurrent();return false;" class="handle extra" id="buttonmultilevel">Tree View</a>
        </li>
        <li class="tagged">
          <a class="extra" id="buttontag" href="" onclick="viewModel.tagCurrent();return false;">Tag</a>
          <a class="extra" id="buttonuntag" href="" onclick="viewModel.unTagCurrent();return false;">Tag</a>
        </li>
        <li>
          <a class="" id="buttondelete" href="" onclick="viewModel.delete();return false;">Delete</a>
        </li>
      </ul>
    </div>

    <div>

      <table>
        <thead>
        </thead>
        <tbody>
          <td style="border-left: none;">
            <a href="http://twitter.com/#!/guyirvine" class="handle" title="www">@guyirvine</a>
          </td>
          <td>
            <a href="" onclick="viewModel.showSearchAdd();return false;" class="handle extra" id="buttonaddword">add word</a>
          </td>
          <td>
            <a href="" onclick="popupmenu();return false;" class='extra' id='displayfootermenu'>...</a>
          </td>
        </tbody>
        <tfoot>
        </tfoot>
      </table>
    </div>
  </footer>


  <script src="bower_components/jquery/jquery.min.js"></script>
  <script src="bower_components/knockout/dist/knockout.js"></script>

  <script src="bower_components/underscore/underscore-min.js"></script>


  <script>

  function popupmenu() {
    $( "#popupmenu" ).toggleClass( "hide" );
    $( "#popupmenu" ).focus();
  }

  function popdownmenu() {
    $( "#popdownmenu" ).toggleClass( "hide" );
  }

  window.onpopstate = function(event) {
    viewModel.popstate( event.state );
  };

  $('#showwordname').keydown(function(e) {
    if(e.keyCode == 13) {
      $('#showwordname').blur();
      return false;
    }
  });

  function MainViewModel() {
    var self = this;

    self.taggedViewModel = new TaggedViewModel();
    self.searchBox = new SearchBoxViewModel();
    self.searchAddBox = new SearchAddBoxViewModel();
    self.shvm = new ShowViewModel();
    self.sevm = new ResultViewModel();
    self.addvm = new AddViewModel();
    history.pushState( {"view": "tagged"}, "", "#tagged" );

    self.search = function() {
      self.searchBox.run();
    };

    self.showSearchAdd = function() {
      $( ".formsearchadd" ).toggleClass( "hide" );
      $( ".formsearchadd input" )[0].value = '';
      $( ".textsearchadd" )[0].focus();
    }

    self.searchadd = function() {
      self.searchAddBox.run();
    };

    self.newWord = function() {
      self.addvm.newWord();
    };
    self.addWord = function() {
      self.addvm.addWord();
    };
    self.loadWords = function() {
      self.addvm.loadWords();
    };
    self.setUrl = function() {
      $.post( "/seturl/" + self.getShowId(), $( "#textseturl" )[0].value, function(id) {
        self.refreshShow();
      });
    }

    self.getShowId = function() {
      return self.shvm.id;
    };
    self.refreshShow = function() {
      self.shvm.run( self.getShowId() );
    };

    self.addLink = function(id) {
      var parent_id = self.getShowId();
      $.post( "/link", JSON.stringify( { 'word_1': parent_id, 'word_2': id }), function(id) {
        $( '#formsearchadd' ).addClass( 'hide' );
        self.refreshShow();
      });
    }

    self.singleLevelCurrent = function() {
      $.post( "/singlelevel/" + self.getShowId(), "", function(id) {
        self.refreshShow();
      });
    };
    self.multiLevelCurrent = function() {
      $.post( "/multilevel/" + self.getShowId(), "", function(id) {
        self.refreshShow();
      });
    };

    self.tagCurrent = function() {
      $.post( "/tag/" + self.getShowId(), "", function(id) {
        $( "#popupmenu .tagged" ).addClass( "tick" );
        $( "#buttontag" ).addClass( "hide" );
        $( "#buttonuntag" ).removeClass( "hide" );
      });
    };
    self.unTagCurrent = function() {
      $.post( "/untag/" + self.getShowId(), "", function(id) {
        $( "#popupmenu .tagged" ).removeClass( "tick" );
        $( "#buttonuntag" ).addClass( "hide" );
        $( "#buttontag" ).removeClass( "hide" );
      });
    };
    self.delete = function() {
      $.post( "/delete/" + self.getShowId(), "", function(id) {
        window.history.back();
      });
    };

    self.changeWord = function() {
      $.post( "/updateword/" + self.getShowId(), $( "#showwordname" )[0].text, function(id) {

      });
    }

    self.popstate = function( state ) {
      $( ".screen" ).addClass( "hide" );
      $( ".extra" ).addClass( "hide" );

      if ( state === null || state.view === null ) {
        self.taggedViewModel.run();
        $( "#tagged" ).removeClass( "hide" );
        return;
      }

      switch ( state.view ) {
        case "result":
        $( "#result" ).removeClass( "hide" );
        break;
        case "tagged":
        self.taggedViewModel.run();
        $( "#tagged" ).removeClass( "hide" );
        break;
        case "show":
        self.shvm.run( state.id );
        $( "#show" ).removeClass( "hide" );
        //        $( "#addnewword" ).removeClass( "hide" );
        break;
        case "add":
        self.addvm.word( "" );
        $( "#add" ).removeClass( "hide" );
        break;
        default:
        $( "#result" ).removeClass( "hide" );
      }
    };

    self.displaySetUrl = function() {
      $( "#formloadwords" ).addClass( "hide" );
      $( "#formaddword" ).addClass( "hide" );
      $( "#popupmenu" ).addClass( "hide" );
      $( "#formseturl" ).removeClass( "hide" );
      $( "#textseturl" ).focus();
    };

    self.hideSetUrl = function() {
      $( "#formseturl" ).addClass( "hide" );
    }

    self.displayTagged = function() {
      $( ".screen" ).addClass( "hide" );
      $( ".extra" ).addClass( "hide" );
      self.taggedViewModel.run();
      history.pushState( { "view": "tagged" }, 'Tagged', "#tagged" );
      $( "#tagged" ).removeClass( "hide" );
    };

    self.displayShow = function( id ) {
      $( ".screen" ).addClass( "hide" );
      $( ".extra" ).addClass( "hide" );
      self.shvm.run( id );
      history.pushState( { "id": id, "view": "show" }, 'Show', "#show" );
      $( "#show" ).removeClass( "hide" );
      $( "#buttonaddword" ).removeClass( "hide" );
      $( "#buttonloadwords" ).removeClass( "hide" );
      $( "#displayfootermenu" ).removeClass( "hide" );
      $( "#displayheadermenu" ).removeClass( "hide" );

    };

    self.displayResult = function() {
      $( ".screen" ).addClass( "hide" );
      $( ".extra" ).addClass( "hide" );
      history.pushState( {"view": "result"}, "", "#result" );
      $( "#result" ).removeClass( "hide" );
      $( "#buttoncancel" ).removeClass( "hide" );
    };

    self.displayAdd = function(_id) {
      $( ".screen" ).addClass( "hide" );
      $( ".extra" ).addClass( "hide" );
      history.pushState( {"view": "add"}, "", "#add" );
      $( "#add" ).removeClass( "hide" );
    };

    self.displayAddWord = function() {
      $( "#formloadwords" ).addClass( "hide" );
      $( "#formaddword" ).toggleClass( "hide" );
      $( "#wordadd" ).focus();
    };


    self.displayLoadWords = function() {
      $( "#formaddword" ).addClass( "hide" );
      $( "#formloadwords" ).toggleClass( "hide" );
      $( "#textarealoadwords" ).focus();

    };

    self.displayTagged();

  }

  function TaggedViewModel() {
    var self = this;

    self.run = function(id) {
      self.id = id;

      $.getJSON( "/tagged", function( _l ) {

        var content = "";
        if ( _l.length === 0 ) {
          content = "<tr><td>No related words found</td></tr>";
        } else {
          _.each( _l, function( el ) {
            content = content + "<tr>" +
            "<td>" +
            "<a onclick='viewModel.displayShow( " + el.id + " );return false;' class='word-" + el.id + "' href=''>" + el.name + "</a>" +
            "</td>" +
            "</tr>";
          });
        }

        $( "#tagged table tbody" ).html( content );

      });
    };

  }


  //*******************************************************
  function SearchAddBoxViewModel() {
    var self = this;

    self.criteria = document.getElementById( "textsearchadd" );

    self.running = false;

    self.run = function() {
      if ( self.running === true ) { return; }
      self.running = true;
      self._run();
      self.running = false;
    };

    self._run = function() {
      if ( self.criteria.value === "" ) { $( "#show table tbody" ).html( "" ); return; }

      var criteria = self.criteria.value;
      $.getJSON( "/search/" + criteria, function( _l ) {
        if ( criteria !== self.criteria.value ) {
          self._run();
        } else {
          var content = "";

          if ( _l.length === 0 ) {
            content = "<tr><td>Search returned no results</td></tr>";
          } else {
            _.each( _l, function( el ) {
              content = content + "<tr>" +
              "<td>" +
              "<a onclick='viewModel.addLink( " + el.id + " );return false;' href=''>" + el.name + "</a>" +
              "</td>" +
              "</tr>";
            });
          }

          $( "#show table tbody" ).html( content );
        }
      });
    };
  }


  //*******************************************************
  function SearchBoxViewModel() {
    var self = this;

    self.criteria = document.getElementById( "criteria" );

    self.running = false;

    self.run = function() {
      if ( self.running === true ) { return; }
      self.running = true;
      if ( $( "#result").hasClass( "hide" ) === true ) {
        viewModel.displayResult();
      }
      self._run();
      self.running = false;
    };

    self._run = function() {
      if ( self.criteria.value === "" ) { $( "#result table tbody" ).html( "" ); return; }

      var criteria = self.criteria.value;
      $.getJSON( "/search/" + criteria, function( _l ) {
        if ( criteria !== self.criteria.value ) {
          self._run();
        } else {
          var content = "";

          if ( _l.length === 0 ) {
            content = "<tr><td>Search returned no results</td></tr>";
          } else {
            _.each( _l, function( el ) {
              content = content + "<tr>" +
              "<td>" +
              "<a onclick='viewModel.displayShow( " + el.id + " );return false;' href=''>" + el.name + "</a>" +
              "</td>" +
              "</tr>";
            });
          }

          $( "#result table tbody" ).html( content );
        }
      });
    };
  }


  function ShowViewModel() {
    var self = this;

    self.id = null;

    self.generate_descendant_html = function(depth, _l) {
      var content = "";
      _.each( _l, function( el ) {
        content = content + "<tr>" +
        "<td>" +
        "<a style='padding-left: " + depth * 2 + "em' onclick='viewModel.displayShow( " + el.id + " );return false;' class='word-" + el.id + "' href=''>" + el.name + "</a>" +
        "</td>" +
        "</tr>";

        content = content + self.generate_descendant_html( depth + 1, el['children'] );
      });

      return content;
    }

    self.run = function(id) {
      self.id = id;

      $.getJSON( "/word/" + id, function( el ) {
        console.log( el );

        var content = '<a id="showwordname" href="" onblur="viewModel.changeWord();return false" contenteditable="true">' + el.name + "</a>";
        if ( el.url != null ) {
          content = content + " <a target='_blank' href='" + el.url + "'><img style='height: 1em' src='img/basic2-284_maximize_window_external_link-128.png' /></a>"
        }

        $( "#textseturl" )[0].value = el.url;

//        $( "#show h1 a" ).html( content );
        $( "#show h1" ).html( content );
        if ( el.tagged == 't' ) {
          $( "#popupmenu .tagged" ).addClass( "tick" );
          $( "#buttontag" ).addClass( "hide" );
          $( "#buttonuntag" ).removeClass( "hide" );
        } else {
          $( "#popupmenu .tagged" ).removeClass( "tick" );
          $( "#buttonuntag" ).addClass( "hide" );
          $( "#buttontag" ).removeClass( "hide" );
        }
        if ( Number( el.showlevels ) > 1 ) {
          $( ".treeview" ).addClass( "tick" );
          $( "#buttonmultilevel" ).addClass( "hide" );
          $( "#buttonsinglelevel" ).removeClass( "hide" );
        } else {
          $( ".treeview" ).removeClass( "tick" );
          $( "#buttonsinglelevel" ).addClass( "hide" );
          $( "#buttonmultilevel" ).removeClass( "hide" );
        }

        if ( Number( el['showlevels'] ) > 1 ) {
          $.getJSON( "/descendants/" + id, function( el ) {
            var content = "";
            if ( el['children'].length === 0 ) {
              content = "<tr><td>No related words found</td></tr>";
            } else {
              content = content + self.generate_descendant_html( 0, el['children'] );
            }

            $( "#show table tbody" ).html( content );

          });

        } else {
        $.getJSON( "/children/" + id, function( _l ) {

          var content = "";
          if ( _l.length === 0 ) {
            content = "<tr><td>No related words found</td></tr>";
          } else {
            _.each( _l, function( el ) {
              content = content + "<tr>" +
              "<td>" +
              "<a onclick='viewModel.displayShow( " + el.id + " );return false;' class='word-" + el.id + "' href=''>" + el.name + "</a>" +
              "</td>" +
              "</tr>";
            });
          }

          $( "#show table tbody" ).html( content );

        });
      }
      });
    };
  }

  function ResultViewModel() {
    var self = this;
  }

  function AddViewModel() {
    var self = this;

    self.newWord = function() {
      var newword = document.getElementById( "wordnew" );
      var word = newword.value.trim();
      if ( word === "" ) {
        return false;
      }

      $.post( "/word", word, function(id) {
        viewModel.displayShow( id );
      });
    };

    self.addWord = function() {
//      var addword = document.getElementById( "wordadd" );
      var addword = document.getElementById( "textsearchadd" );
      var word = addword.value.trim();
      if ( word === "" ) {
        return false;
      }

      $.post( "/word", word, function(id) {
        $.post( "/link", JSON.stringify({ word_1: id, word_2: viewModel.getShowId() }), function() {
          viewModel.refreshShow();
          addword.value = "";
        });
      });
      $( "#formsearchadd" ).addClass( "hide" );
    };

    self.loadWords = function() {
      var textareawords = document.getElementById( "textarealoadwords" );
      var words = textareawords.value.trim();
      if ( words === "" ) {
        return false;
      }

      $.post( "/loadwords", JSON.stringify({ words: words, id: viewModel.getShowId() }), function() {
        viewModel.refreshShow();
        textareawords.value = "";
      });
      $( "#formaddword" ).addClass( "hide" );
    };

  }

  window.onerror = function( msg, url, line, col, error ) {
    alert( msg + "\nline: " + line );
  };

  var viewModel = new MainViewModel();
  //        document.getElementById( "criteria" ).value = 'an';
  </script>

</body>
</html>
